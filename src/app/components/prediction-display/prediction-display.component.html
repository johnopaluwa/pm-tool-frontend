<div class="prediction-review-container">
  <h2>Prediction Review</h2>
  <div *ngIf="error" class="error-message">{{ error }}</div>
  <div *ngIf="loading" class="loading-message">Loading predictions...</div>
  <div class="prediction-legend">
    <p>
      <strong>Score:</strong> Indicates the similarity score of the prediction.
    </p>
    <p>
      <strong>Commonality:</strong> Shows how frequently similar items appear in
      the source data.
    </p>
    <p><strong>Source:</strong> Specifies the origin of the prediction.</p>
  </div>

  <div *ngIf="!error && !loading">
    <section class="prediction-section">
      <h3>Predicted User Stories</h3>
      <div
        *ngIf="filteredUserStoryPredictions.length === 0"
        class="empty-message"
      >
        No user story predictions found.
      </div>
      <ul
        class="prediction-list"
        *ngIf="filteredUserStoryPredictions.length > 0"
      >
        <li
          *ngFor="let pred of filteredUserStoryPredictions"
          [class.accepted]="pred.status === 'accepted'"
          [class.rejected]="pred.status === 'rejected'"
          class="prediction-list-item"
          (click)="pred.isCollapsed = !pred.isCollapsed"
        >
          <div class="list-item-header">
            <span class="prediction-title">{{ pred.title }}</span>
            <span class="collapse-icon">{{
              pred.isCollapsed ? "+" : "-"
            }}</span>
          </div>
          <div class="prediction-main">
            <span class="prediction-score"
              >Score: {{ pred.similarityScore }}%</span
            >
            <span class="prediction-freq"
              >Commonality: {{ pred.frequency }}%</span
            >
            <span class="prediction-source"
              >Source: {{ pred.sourceProject }}</span
            >
            <span
              class="prediction-time"
              *ngIf="
                pred.estimatedTime !== undefined && pred.estimatedTime !== null
              "
            >
              <strong>Est. Time:</strong> {{ pred.estimatedTime }}h
            </span>
          </div>
          <div class="list-item-details" [hidden]="pred.isCollapsed">
            <div class="prediction-desc">{{ pred.description }}</div>
            <!-- Display additional user story details -->
            <div *ngIf="pred.type === 'user-story'" class="prediction-details">
              <p *ngIf="pred.acceptanceCriteria">
                <strong>Acceptance Criteria:</strong>
                {{ pred.acceptanceCriteria.join("; ") }}
              </p>
              <p *ngIf="pred.dependencies">
                <strong>Dependencies:</strong>
                {{ pred.dependencies.join(", ") }}
              </p>
              <p *ngIf="pred.assumptions">
                <strong>Assumptions:</strong> {{ pred.assumptions.join("; ") }}
              </p>
              <p *ngIf="pred.edgeCases">
                <strong>Edge Cases:</strong> {{ pred.edgeCases.join("; ") }}
              </p>
              <p *ngIf="pred.nonFunctionalRequirements">
                <strong>Non-Functional Requirements:</strong>
                {{ pred.nonFunctionalRequirements }}
              </p>
              <p *ngIf="pred.visuals">
                <strong>Visuals:</strong> {{ pred.visuals.join(", ") }}
              </p>
              <p *ngIf="pred.dataRequirements">
                <strong>Data Requirements:</strong> {{ pred.dataRequirements }}
              </p>
              <p *ngIf="pred.impact">
                <strong>Impact:</strong> {{ pred.impact }}
              </p>
              <p *ngIf="pred.priority">
                <strong>Priority:</strong> {{ pred.priority }}
              </p>
            </div>
            <!-- Display additional bug details -->
            <div *ngIf="pred.type === 'bug'" class="prediction-details">
              <p *ngIf="pred.stepsToReproduce">
                <strong>Steps to Reproduce:</strong>
                {{ pred.stepsToReproduce.join(" -> ") }}
              </p>
              <p *ngIf="pred.actualResult">
                <strong>Actual Result:</strong> {{ pred.actualResult }}
              </p>
              <p *ngIf="pred.expectedResult">
                <strong>Expected Result:</strong> {{ pred.expectedResult }}
              </p>
              <p *ngIf="pred.environment">
                <strong>Environment:</strong> {{ pred.environment }}
              </p>
              <p *ngIf="pred.userAccountDetails">
                <strong>User/Account Details:</strong>
                {{ pred.userAccountDetails }}
              </p>
              <p *ngIf="pred.screenshotsVideos">
                <strong>Screenshots/Videos:</strong>
                {{ pred.screenshotsVideos.join(", ") }}
              </p>
              <p *ngIf="pred.errorMessagesLogs">
                <strong>Error Messages/Logs:</strong>
                {{ pred.errorMessagesLogs }}
              </p>
              <p *ngIf="pred.frequencyOfOccurrence">
                <strong>Frequency:</strong> {{ pred.frequencyOfOccurrence }}
              </p>
              <p *ngIf="pred.severity">
                <strong>Severity:</strong> {{ pred.severity }}
              </p>
              <p *ngIf="pred.workaround">
                <strong>Workaround:</strong> {{ pred.workaround }}
              </p>
              <p *ngIf="pred.relatedIssues">
                <strong>Related Issues:</strong>
                {{ pred.relatedIssues.join(", ") }}
              </p>
            </div>
          </div>
        </li>
      </ul>
    </section>

    <section class="prediction-section">
      <h3>Predicted Bugs / Potential Issues</h3>
      <div *ngIf="filteredBugPredictions.length === 0" class="empty-message">
        No bug predictions found.
      </div>
      <ul class="prediction-list" *ngIf="filteredBugPredictions.length > 0">
        <li
          *ngFor="let pred of filteredBugPredictions"
          [class.accepted]="pred.status === 'accepted'"
          [class.rejected]="pred.status === 'rejected'"
          class="prediction-list-item"
          (click)="pred.isCollapsed = !pred.isCollapsed"
        >
          <div class="list-item-header">
            <span class="prediction-title">{{ pred.title }}</span>
            <span class="collapse-icon">{{
              pred.isCollapsed ? "+" : "-"
            }}</span>
          </div>
          <div class="prediction-main">
            <span class="prediction-score"
              >Score: {{ pred.similarityScore }}%</span
            >
            <span class="prediction-freq"
              >Commonality: {{ pred.frequency }}%</span
            >
            <span class="prediction-source"
              >Source: {{ pred.sourceProject }}</span
            >
            <span
              class="prediction-time"
              *ngIf="
                pred.estimatedTime !== undefined && pred.estimatedTime !== null
              "
            >
              <strong>Est. Time:</strong> {{ pred.estimatedTime }}h
            </span>
          </div>
          <div class="list-item-details" [hidden]="pred.isCollapsed">
            <div class="prediction-desc">{{ pred.description }}</div>
            <!-- Display additional user story details -->
            <div *ngIf="pred.type === 'user-story'" class="prediction-details">
              <p *ngIf="pred.acceptanceCriteria">
                <strong>Acceptance Criteria:</strong>
                {{ pred.acceptanceCriteria.join("; ") }}
              </p>
              <p *ngIf="pred.dependencies">
                <strong>Dependencies:</strong>
                {{ pred.dependencies.join(", ") }}
              </p>
              <p *ngIf="pred.assumptions">
                <strong>Assumptions:</strong> {{ pred.assumptions.join("; ") }}
              </p>
              <p *ngIf="pred.edgeCases">
                <strong>Edge Cases:</strong> {{ pred.edgeCases.join("; ") }}
              </p>
              <p *ngIf="pred.nonFunctionalRequirements">
                <strong>Non-Functional Requirements:</strong>
                {{ pred.nonFunctionalRequirements }}
              </p>
              <p *ngIf="pred.visuals">
                <strong>Visuals:</strong> {{ pred.visuals.join(", ") }}
              </p>
              <p *ngIf="pred.dataRequirements">
                <strong>Data Requirements:</strong> {{ pred.dataRequirements }}
              </p>
              <p *ngIf="pred.impact">
                <strong>Impact:</strong> {{ pred.impact }}
              </p>
              <p *ngIf="pred.priority">
                <strong>Priority:</strong> {{ pred.priority }}
              </p>
            </div>
            <!-- Display additional bug details -->
            <div *ngIf="pred.type === 'bug'" class="prediction-details">
              <p *ngIf="pred.stepsToReproduce">
                <strong>Steps to Reproduce:</strong>
                {{ pred.stepsToReproduce.join(" -> ") }}
              </p>
              <p *ngIf="pred.actualResult">
                <strong>Actual Result:</strong> {{ pred.actualResult }}
              </p>
              <p *ngIf="pred.expectedResult">
                <strong>Expected Result:</strong> {{ pred.expectedResult }}
              </p>
              <p *ngIf="pred.environment">
                <strong>Environment:</strong> {{ pred.environment }}
              </p>
              <p *ngIf="pred.userAccountDetails">
                <strong>User/Account Details:</strong>
                {{ pred.userAccountDetails }}
              </p>
              <p *ngIf="pred.screenshotsVideos">
                <strong>Screenshots/Videos:</strong>
                {{ pred.screenshotsVideos.join(", ") }}
              </p>
              <p *ngIf="pred.errorMessagesLogs">
                <strong>Error Messages/Logs:</strong>
                {{ pred.errorMessagesLogs }}
              </p>
              <p *ngIf="pred.frequencyOfOccurrence">
                <strong>Frequency:</strong> {{ pred.frequencyOfOccurrence }}
              </p>
              <p *ngIf="pred.severity">
                <strong>Severity:</strong> {{ pred.severity }}
              </p>
              <p *ngIf="pred.workaround">
                <strong>Workaround:</strong> {{ pred.workaround }}
              </p>
              <p *ngIf="pred.relatedIssues">
                <strong>Related Issues:</strong>
                {{ pred.relatedIssues.join(", ") }}
              </p>
            </div>
          </div>
        </li>
      </ul>
    </section>

    <div class="review-actions">
      <button
        class="finish-btn"
        (click)="finishReview()"
        *ngIf="project && project.status !== 'completed'"
      >
        Generate Report
      </button>
      <!-- New button to view report when available -->
      <button
        class="finish-btn"
        (click)="viewProjectReport()"
        *ngIf="project && project.status === 'completed'"
      >
        View Report →
      </button>
    </div>
  </div>
</div>
